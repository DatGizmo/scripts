#!/bin/bash
stream=$1
title=""
url=""

function getTwitchTitle()
{
	stre=$1
	search="twitch.tv/"
	chan="${stre#*$search}"
	echo $(curl -s -H "Authorization: Bearer ts0uqmsefzrjrh04gtizfkk48bbtjg" -X GET https://api.twitch.tv/helix/streams\?user_login=$chan | jq -r '[.data[0].user_name,.data[0].title] | @csv' |  awk -F, '/,/ { gsub ("\"",""); print $1": "$2 }')
}

if [[ $stream == *"twitch.tv"* ]]; then
	title=$(getTwitchTitle $stream)
	url=$stream
elif [[ $stream == "http"* ]]; then
	url=$stream
	title="Live stream"
else
	url="twitch.tv/$stream"
	title=$(getTwitchTitle $stream)
fi

streamlink \
--no-version-check \
--player mpv \
--player-no-close \
--player-args="--title \"$title\" \
{filename} " \
--twitch-oauth-token=ts0uqmsefzrjrh04gtizfkk48bbtjg \
--hls-live-edge 1 \
--hds-live-edge 1 \
--hls-segment-threads 1 \
--retry-open 1 \
--retry-streams 1 \
--retry-max 10 \
$url best
